<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");

let animationId = null;
let playing = false;
let score = 0;
let life = 100;
let speed = 4;

let player = { x:180, y:500, width:40, height:40 };
let notes = [];
let particles = [];
let stars = [];
let spawnTimer = 0;

// ‚≠ê fondo estrellas
for(let i=0;i<80;i++){
    stars.push({
        x: Math.random()*400,
        y: Math.random()*600,
        size: Math.random()*2,
        speed: Math.random()*0.5+0.2
    });
}

startBtn.addEventListener("click", startGame);

function startGame(){
    document.getElementById("startScreen").style.display="none";
    document.getElementById("hud").style.display="block";
    canvas.style.display="block";

    score = 0;
    life = 100;
    speed = 4;
    notes = [];
    particles = [];

    document.getElementById("score").innerText = score;

    playing = true;

    if(animationId) cancelAnimationFrame(animationId);
    gameLoop();
}

function gameLoop(){
    if(!playing) return;

    ctx.clearRect(0,0,400,600);

    drawBackground();
    drawLifeBar();
    drawPlayer();
    spawnNotes();
    updateNotes();
    updateParticles();
    checkGameOver();

    animationId = requestAnimationFrame(gameLoop);
}

function drawBackground(){
    ctx.fillStyle="black";
    ctx.fillRect(0,0,400,600);

    ctx.fillStyle="white";
    for(let s of stars){
        ctx.fillRect(s.x, s.y, s.size, s.size);
        s.y += s.speed;
        if(s.y > 600){
            s.y = 0;
            s.x = Math.random()*400;
        }
    }
}

function drawLifeBar(){
    ctx.fillStyle="red";
    ctx.fillRect(10,40,life*2,10);

    ctx.strokeStyle="white";
    ctx.strokeRect(10,40,200,10);
}

function drawPlayer(){
    ctx.fillStyle="red";
    ctx.fillRect(player.x, player.y, player.width, player.height);
}

function spawnNotes(){
    spawnTimer++;
    if(spawnTimer > 25){
        notes.push({
            x: Math.random()*360,
            y: -20,
            width:20,
            height:20
        });
        spawnTimer = 0;
    }
}

function updateNotes(){
    for(let i = notes.length-1; i>=0; i--){
        let n = notes[i];
        n.y += speed;

        ctx.fillStyle="white";
        ctx.fillRect(n.x, n.y, n.width, n.height);

        if(n.y > 600){
            life -= 10;
            notes.splice(i,1);
            continue;
        }

        if(n.x < player.x + player.width &&
           n.x + n.width > player.x &&
           n.y < player.y + player.height &&
           n.y + n.height > player.y){

            score++;
            speed += 0.2; // aumenta dificultad
            document.getElementById("score").innerText = score;

            createParticles(n.x + 10, n.y + 10);

            notes.splice(i,1);
        }
    }
}

function createParticles(x,y){
    for(let i=0;i<8;i++){
        particles.push({
            x:x,
            y:y,
            dx:(Math.random()-0.5)*4,
            dy:(Math.random()-0.5)*4,
            life:25
        });
    }
}

function updateParticles(){
    ctx.fillStyle="orange";
    for(let i=particles.length-1;i>=0;i--){
        let p = particles[i];
        p.x += p.dx;
        p.y += p.dy;
        p.life--;

        ctx.fillRect(p.x, p.y, 3, 3);

        if(p.life <= 0){
            particles.splice(i,1);
        }
    }
}

function checkGameOver(){
    if(life <= 0){
        playing = false;
        ctx.fillStyle="white";
        ctx.font="40px Arial";
        ctx.fillText("GAME OVER",80,300);
    }
}

document.addEventListener("keydown", function(e){
    if(e.key === "ArrowLeft") player.x -= 20;
    if(e.key === "ArrowRight") player.x += 20;

    if(player.x < 0) player.x = 0;
    if(player.x > 360) player.x = 360;
});
</script>
